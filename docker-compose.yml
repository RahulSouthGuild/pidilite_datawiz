version: '3.8'

services:
  starrocks-fe-1:
    image: starrocks/fe-ubuntu:3.3-latest
    container_name: starrocks-fe-1
    hostname: starrocks-fe-1
    command: /opt/starrocks/fe/bin/start_fe.sh
    ports:
      - "8030:8030"
      - "9020:9020"
      - "9030:9030"
      - "9010:9010"
    volumes:
      - fe1_meta:/opt/starrocks/fe/meta
      - ./fe.conf:/opt/starrocks/fe/conf/fe.conf
    environment:
      - JAVA_OPTS=-Xmx4g -Xms4g -XX:+UseG1GC -XX:MaxGCPauseMillis=200
    networks:
      starrocks_net:
        ipv4_address: 172.18.0.10
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8030/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

  starrocks-fe-2:
    image: starrocks/fe-ubuntu:3.3-latest
    container_name: starrocks-fe-2
    hostname: starrocks-fe-2
    command: /opt/starrocks/fe/bin/start_fe.sh --helper starrocks-fe-1:9010
    depends_on:
      starrocks-fe-1:
        condition: service_healthy
    ports:
      - "8031:8030"
      - "9021:9020"
      - "9031:9030"
      - "9011:9010"
    volumes:
      - fe2_meta:/opt/starrocks/fe/meta
      - ./fe.conf:/opt/starrocks/fe/conf/fe.conf
    environment:
      - JAVA_OPTS=-Xmx4g -Xms4g -XX:+UseG1GC -XX:MaxGCPauseMillis=200
    networks:
      starrocks_net:
        ipv4_address: 172.18.0.11
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8030/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 150s

  starrocks-be-1:
    image: starrocks/be-ubuntu:3.3-latest
    container_name: starrocks-be-1
    hostname: starrocks-be-1
    command: /opt/starrocks/be/bin/start_be.sh
    depends_on:
      starrocks-fe-1:
        condition: service_healthy
    ports:
      - "8040:8040"
      - "9060:9060"
      - "8060:8060"
      - "9050:9050"
    volumes:
      - be1_storage:/opt/starrocks/be/storage
      - ./be-1.conf:/opt/starrocks/be/conf/be.conf
    environment:
      - BE_MEM_LIMIT=80%
      - STORAGE_ROOT_PATH=/opt/starrocks/be/storage,medium:ssd
    networks:
      starrocks_net:
        ipv4_address: 172.18.0.20
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8040/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

  starrocks-be-2:
    image: starrocks/be-ubuntu:3.3-latest
    container_name: starrocks-be-2
    hostname: starrocks-be-2
    command: /opt/starrocks/be/bin/start_be.sh
    depends_on:
      starrocks-fe-1:
        condition: service_healthy
    ports:
      - "8041:8040"
      - "9061:9060"
      - "8061:8060"
      - "9051:9050"
    volumes:
      - be2_storage:/opt/starrocks/be/storage
      - ./be-2.conf:/opt/starrocks/be/conf/be.conf
    environment:
      - BE_MEM_LIMIT=80%
      - STORAGE_ROOT_PATH=/opt/starrocks/be/storage,medium:ssd
    networks:
      starrocks_net:
        ipv4_address: 172.18.0.21
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8040/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s

  # Initialization service - registers backends automatically
  starrocks-init:
    image: starrocks/fe-ubuntu:3.3-latest
    container_name: starrocks-init
    depends_on:
      starrocks-fe-1:
        condition: service_healthy
      starrocks-be-1:
        condition: service_healthy
      starrocks-be-2:
        condition: service_healthy
    networks:
      - starrocks_net
    command: >
      bash -c "
      sleep 20 &&
      echo 'Registering Backend 1' &&
      mysql -uroot -hstarrocks-fe-1 -P9030 <<< 'ALTER SYSTEM ADD BACKEND \"starrocks-be-1:9050\";' &&
      echo 'Registering Backend 2' &&
      mysql -uroot -hstarrocks-fe-1 -P9030 <<< 'ALTER SYSTEM ADD BACKEND \"starrocks-be-2:9050\";' &&
      echo 'Initialization complete!'
      "
    restart: "no"

networks:
  starrocks_net:
    driver: bridge
    ipam:
      config:
        - subnet: 172.18.0.0/16
          gateway: 172.18.0.1

volumes:
  fe1_meta:
    driver: local
  fe2_meta:
    driver: local
  be1_storage:
    driver: local
  be2_storage:
    driver: local
